<script>
// ========================================================================
// STATE
// ========================================================================
let TRIPS = [];
let selectedTripId = null;
let globe = null;
let idleTimeout = null;
let pulseAnimationId = null;
let pulsePhase = 0;
const IDLE_RESUME_DELAY = 3000; // Resume auto-rotation after 3s of inactivity

// Animation state
let drawProgress = 0;           // 0 to 1 for page load draw-in
let isYearInReview = false;     // Year in Review mode active
let yearInReviewArcs = [];      // Accumulated arcs during Year in Review
let isTripAnimating = false;    // Single trip animation active
let tripAnimationArcs = [];     // Accumulated arcs during single trip animation

// 2D Map overlay state
let leafletMap = null;          // Leaflet map instance
let mapRouteLayer = null;       // Current route polyline
let mapMarkerLayer = null;      // Traveling marker
const SHORT_LEG_THRESHOLD = 650; // km - legs shorter than this use 2D map (covers ~SF-LA)

// ========================================================================
// DOM ELEMENTS
// ========================================================================
const $ = id => document.getElementById(id);
const loading = $('loading');
const content = $('content');
const tripList = $('trip-list');
const tripStrip = $('trip-strip');
const detailsPanel = $('details-panel');
const bottomSheet = $('bottom-sheet');
const globeContainer = $('globe-container');

// ========================================================================
// HELPERS
// ========================================================================

/**
 * Extract airport code from a leg's origin/destination.
 * Handles both string format ("JFK") and object format ({ code: "JFK", ... })
 */
function getCode(location) {
  if (!location) return '';
  return typeof location === 'string' ? location : (location.code || '');
}

/**
 * Extract display code/name from a leg's origin/destination.
 * For flights: returns airport code (e.g., "JFK")
 * For other modes: returns shortened city name
 */
function getLocationDisplay(location, mode) {
  if (!location) return '';
  
  if (mode === 'flight') {
    // Return code for flights
    return typeof location === 'string' ? location : (location.code || location.name || '');
  } else {
    // Return name for other modes, shortened if needed
    const name = typeof location === 'string' ? location : (location.name || '');
    // Truncate long names: "Paris, Île-de-France, France" → "Paris"
    return name.split(',')[0].trim();
  }
}

/**
 * Parse a YYYY-MM-DD string as local date (not UTC).
 * new Date("2026-02-02") treats it as UTC midnight, which shifts back a day in US timezones.
 */
function parseLocalDate(dateStr) {
  if (!dateStr) return new Date();
  const parts = dateStr.toString().split('-');
  if (parts.length !== 3) return new Date(dateStr + 'T00:00:00');
  return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
}

function formatDateRange(start, end) {
  const s = parseLocalDate(start), e = parseLocalDate(end);
  const opts = { month: 'short', day: 'numeric' };
  return `${s.toLocaleDateString('en-US', opts)} - ${e.toLocaleDateString('en-US', opts)}, ${s.getFullYear()}`;
}

function formatDateRangeShort(start, end) {
  const s = parseLocalDate(start), e = parseLocalDate(end);
  return `${s.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}-${e.getDate()}`;
}

function getDays(start, end) {
  return Math.ceil((parseLocalDate(end) - parseLocalDate(start)) / (1000 * 60 * 60 * 24)) + 1;
}

/**
 * Utility sleep function for async animation sequences
 */
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/**
 * Interpolate between two hex colors
 * t = 0 returns color1, t = 1 returns color2
 */
function interpolateColor(color1, color2, t) {
  // Parse hex colors
  const r1 = parseInt(color1.slice(1, 3), 16);
  const g1 = parseInt(color1.slice(3, 5), 16);
  const b1 = parseInt(color1.slice(5, 7), 16);
  
  const r2 = parseInt(color2.slice(1, 3), 16);
  const g2 = parseInt(color2.slice(3, 5), 16);
  const b2 = parseInt(color2.slice(5, 7), 16);
  
  // Interpolate
  const r = Math.round(r1 + (r2 - r1) * t);
  const g = Math.round(g1 + (g2 - g1) * t);
  const b = Math.round(b1 + (b2 - b1) * t);
  
  return `rgb(${r}, ${g}, ${b})`;
}

/**
 * Calculate great-circle distance between two points in km (Haversine formula)
 */
function getDistanceKm(lat1, lng1, lat2, lng2) {
  const R = 6371; // Earth's radius in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function showLoaded() {
  loading.classList.add('opacity-0', 'pointer-events-none');
  content.classList.remove('opacity-0');
}

function showLoading() {
  loading.classList.remove('opacity-0', 'pointer-events-none');
  content.classList.add('opacity-0');
}

// ========================================================================
// DATA LOADING
// ========================================================================

/**
 * Load trip data from Google Sheets via Apps Script
 */
function loadTripData() {
  console.log('Loading trip data...');
  
  // Check if google.script.run is available
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    console.error('google.script.run is not available - are you running in Apps Script?');
    onDataError(new Error('google.script.run not available'));
    return;
  }
  
  try {
    google.script.run
      .withSuccessHandler(onDataLoaded)
      .withFailureHandler(onDataError)
      .getTripData();
  } catch (e) {
    console.error('Exception calling google.script.run:', e);
    onDataError(e);
  }
}

/**
 * Called when data is successfully loaded
 */
function onDataLoaded(data) {
  console.log('Data loaded:', data);
  TRIPS = data && data.trips ? data.trips : [];
  renderTripList();
  renderDetails(null);
  
  // Setup CRUD event listeners
  setupCrudEventListeners();
  
  // Fetch app title from config
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(title => {
        if (title) {
          const titleEl = document.getElementById('app-title');
          if (titleEl) titleEl.textContent = title;
          document.title = title;
        }
      })
      .getAppTitle();
  }
  
  // Initialize globe, then arcs, then show loaded state
  initGlobe(() => {
    initArcs();
    showLoaded();
  });
}

/**
 * Called if data loading fails
 */
function onDataError(error) {
  console.error('Failed to load trip data:', error);
  // Show empty state
  TRIPS = [];
  renderTripList();
  renderDetails(null);
  
  // Setup CRUD event listeners even on error (allows adding trips)
  setupCrudEventListeners();
  
  // Still initialize globe even on data error
  initGlobe(() => {
    initArcs();
    showLoaded();
  });
}

function reloadTrips() {
  google.script.run
    .withSuccessHandler(data => {
      TRIPS = (data && data.trips) ? data.trips : [];
      renderTripList();
      renderDetails(TRIPS.find(t => t.id === selectedTripId));
      updateArcs();
    })
    .withFailureHandler(err => console.error('Failed to reload:', err))
    .getTripData();
}

// ========================================================================
// INIT
// ========================================================================
console.log('Initializing app...');

// Check if Globe.gl loaded
if (typeof Globe === 'undefined') {
  console.error('Globe.gl library failed to load! Check if CDN is accessible.');
  document.getElementById('loading').innerHTML = '<div style="color: #f87171; text-align: center; padding: 20px;">Error: Globe.gl library failed to load.<br>External scripts may be blocked.</div>';
} else {
  console.log('Globe.gl loaded successfully');
  loadTripData();
}
</script>

